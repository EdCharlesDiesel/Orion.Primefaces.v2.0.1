<div class="container" *ngIf="vm$ | async as vm">
  <!-- Header with total inventory -->
  <div class="header" *ngIf="!vm.isLoading && vm.products.length > 0">
    <h2>Products</h2>
    <p class="inventory-total">
      <mat-icon>inventory</mat-icon>
      Total Stock: {{ vm.totalInventory }} items
    </p>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="vm.isLoading">
    <mat-spinner></mat-spinner>
    <p>Loading products...</p>
  </div>

  <!-- Error State -->
  <div class="error-container" *ngIf="vm.error">
    <mat-icon color="warn">error</mat-icon>
    <p>{{ vm.error }}</p>
    <button mat-raised-button color="primary" (click)="loadProducts()">
      <mat-icon>refresh</mat-icon> Retry
    </button>
  </div>

  <!-- Products Grid -->
  <div class="products-container" *ngIf="!vm.isLoading && vm.products.length > 0">
    <div class="products-grid">
      <mat-card
        class="product-card"
        [class.out-of-stock]="isOutOfStock(product)"
        [class.low-stock]="isLowStock(product)"
        *ngFor="let product of vm.products; trackBy: trackByProductId">

        <!-- Stock badge -->
        <div class="stock-badge"
             [class.out-of-stock-badge]="isOutOfStock(product)"
             [class.low-stock-badge]="isLowStock(product)">
          <mat-icon>inventory_2</mat-icon>
          <span>{{ product.quantityInStock }} in stock</span>
        </div>

        <img mat-card-image [src]="product.image" [alt]="product.title" class="product-image">

        <mat-card-header>
          <mat-card-title class="product-title">{{ product.title }}</mat-card-title>
          <mat-card-subtitle>{{ product.category }}</mat-card-subtitle>
        </mat-card-header>

        <mat-card-content>
          <div class="rating">
            <mat-icon class="star-icon">star</mat-icon>
            <span>{{ product.rating.rate }} ({{ product.rating.count }} reviews)</span>
          </div>
          <p class="price">{{ product.price | currency:'USD' }}</p>
          <p class="description">{{ product.description | slice:0:100 }}...</p>
        </mat-card-content>

        <mat-card-actions>
          <button
            mat-raised-button
            color="primary"
            (click)="addToCart(product)"
            [disabled]="isOutOfStock(product)">
            <mat-icon>shopping_cart</mat-icon>
            {{ isOutOfStock(product) ? 'Out of Stock' : 'Add to Cart' }}
          </button>
          <button mat-icon-button color="warn" (click)="removeProductNow(product.id)">
            <mat-icon>delete</mat-icon>
          </button>
        </mat-card-actions>
      </mat-card>
    </div>
  </div>

  <!-- No Products State -->
  <div class="no-products" *ngIf="!vm.isLoading && vm.products.length === 0 && !vm.error">
    <mat-icon>inventory_2</mat-icon>
    <p>No products available at the moment.</p>
    <button mat-raised-button color="primary" (click)="loadProducts()">
      <mat-icon>refresh</mat-icon> Retry
    </button>
  </div>
</div>
